<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control del Bot de Reservas de P√°del</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://rsms.me/inter/inter.css');
        body { font-family: 'Inter', sans-serif; }
        .tab-active { border-color: #3b82f6; color: #3b82f6; background-color: #eff6ff; }
        .tab-inactive { border-color: transparent; }
    </style>
</head>
<body class="bg-slate-100">
    <div id="app" class="max-w-4xl mx-auto p-4 sm:p-6 lg:p-8">
        
        <header class="text-center mb-8">
            <h1 class="text-4xl font-extrabold text-slate-900 tracking-tight">ü§ñ Bot de Reservas de P√°del</h1>
            <p class="mt-2 text-lg text-slate-600">Tu asistente personal para no quedarte sin cancha</p>
        </header>

        <div class="mb-6">
            <div class="border-b border-slate-200">
                <nav class="-mb-px flex space-x-6" aria-label="Tabs">
                    <button v-for="tab in tabs" @click="activeTab = tab.name" :class="[activeTab === tab.name ? 'tab-active' : 'tab-inactive', 'whitespace-nowrap py-4 px-3 border-b-2 font-medium text-sm transition-colors duration-200 rounded-t-lg']">
                        {{ tab.label }}
                    </button>
                </nav>
            </div>
        </div>

        <!-- Pesta√±a de Configuraci√≥n -->
        <div v-show="activeTab === 'config'" class="space-y-8 animate-fade-in">
            <!-- Detalles de la Reserva -->
            <div class="bg-white p-6 rounded-2xl shadow-lg border border-slate-100">
                <h3 class="text-xl font-bold mb-4">1. Configura tu Reserva</h3>
                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-slate-700">Fecha de Reserva</label>
                        <input type="date" v-model="config.date" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700">Cancha Preferida</label>
                        <select v-model="config.space_name" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2">
                            <option>Cancha uno</option>
                            <option>Cancha dos</option>
                            <option>Cancha tres</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Selecci√≥n de Horarios -->
            <div class="bg-white p-6 rounded-2xl shadow-lg border border-slate-100">
                <h3 class="text-xl font-bold mb-4">2. Horarios a Reservar (elige en orden)</h3>
                <div class="grid grid-cols-4 sm:grid-cols-6 lg:grid-cols-8 gap-3">
                    <div v-for="hour in availableHours" :key="hour">
                        <button @click="toggleHour(hour)" :class="{'ring-2 ring-blue-500 bg-blue-500 text-white': config.target_hours.includes(hour), 'bg-slate-100 text-slate-700 hover:bg-slate-200': !config.target_hours.includes(hour)}" class="w-full text-center p-3 rounded-lg font-semibold transition-all duration-200 relative">
                            {{ hour }}
                            <span v-if="config.target_hours.indexOf(hour) !== -1" class="absolute -top-2 -right-2 w-6 h-6 bg-blue-600 text-white text-xs rounded-full flex items-center justify-center border-2 border-white">
                                {{ config.target_hours.indexOf(hour) + 1 }}
                            </span>
                        </button>
                    </div>
                </div>
                <div v-if="config.target_hours.length > 0" class="mt-4 bg-blue-50 border-l-4 border-blue-400 p-4 rounded-r-lg">
                    <p class="text-sm text-blue-800">
                        <strong>Orden de reserva:</strong> {{ config.target_hours.join(' ‚Üí ') }}. Se intentar√°n reservar todos en este orden.
                    </p>
                </div>
            </div>
            <div class="flex justify-end">
                 <button @click="saveConfig" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
                    {{ saveButtonText }}
                </button>
            </div>
        </div>

        <!-- Pesta√±a de Ejecuci√≥n -->
        <div v-show="activeTab === 'execute'" class="animate-fade-in">
             <div class="bg-white p-6 rounded-2xl shadow-lg border border-slate-100">
                <h3 class="text-xl font-bold mb-2">üöÄ Ejecutar el Bot</h3>
                <p class="text-slate-600 mb-6">Este es el m√©todo final y recomendado para usar en tu iPad o computadora.</p>
                
                <div class="bg-amber-50 border-l-4 border-amber-400 p-4 rounded-r-lg mb-6">
                    <h4 class="font-bold text-amber-800">¬°Atenci√≥n!</h4>
                    <p class="text-sm text-amber-700">Para que el bot funcione, debes dejar esta pesta√±a del navegador **abierta y en primer plano** en tu dispositivo a las 12:00 AM.</p>
                </div>
                
                <div class="text-center">
                    <button @click="schedule" class="bg-blue-600 text-white font-bold py-4 px-8 rounded-full hover:bg-blue-700 transition text-lg shadow-lg">
                        Programar para las 12:00 AM
                    </button>
                    <div id="bot-status" class="mt-6 text-lg text-gray-800 p-4 bg-gray-50 rounded-lg font-medium">{{ status }}</div>
                    <div id="countdown" class="text-center text-5xl font-mono font-bold mt-4 text-slate-800"></div>
                </div>
             </div>
        </div>

    </div>

    <script src="https://unpkg.com/vue@3"></script>
    <script>
    const { createApp, ref, onMounted } = Vue;
    createApp({
        setup() {
            const activeTab = ref('config');
            const tabs = [
                { name: 'config', label: '1. Configuraci√≥n' },
                { name: 'execute', label: '2. Programar y Ejecutar' }
            ];
            const defaultConfig = {
                date: new Date(Date.now() + 1728e5).toISOString().split("T")[0],
                target_hours: ["07:00", "08:00"],
                space_name: "Cancha uno"
            };
            const config = ref(JSON.parse(localStorage.getItem('botConfig')) || defaultConfig);
            
            const status = ref("Listo para programar.");
            let intervalId = null;
            const saveButtonText = ref('Guardar Configuraci√≥n');

            const availableHours = Array.from({length: 15}, (_, i) => `${String(i + 7).padStart(2, '0')}:00`);

            const toggleHour = (hour) => {
                const index = config.value.target_hours.indexOf(hour);
                if (index > -1) {
                    config.value.target_hours.splice(index, 1);
                } else {
                    config.value.target_hours.push(hour);
                }
            };

            const saveConfig = () => {
                localStorage.setItem('botConfig', JSON.stringify(config.value));
                saveButtonText.value = '¬°Guardado!';
                setTimeout(() => { saveButtonText.value = 'Guardar Configuraci√≥n'; }, 2000);
            };

            const schedule = () => {
                clearInterval(intervalId);
                const now = new Date();
                let midnight = new Date(now);
                midnight.setHours(24, 0, 0, 0);

                status.value = "Programado. Esperando a la medianoche...";
                document.getElementById('bot-status').style.color = '#2563eb';

                intervalId = setInterval(() => {
                    const t = midnight.getTime() - new Date().getTime();
                    if (t <= 0) {
                        clearInterval(intervalId);
                        executeBot();
                        return;
                    }
                    const h = Math.floor(t / 36e5);
                    const m = Math.floor(t % 36e5 / 6e4);
                    const s = Math.floor(t % 6e4 / 1e3);
                    document.getElementById('countdown').textContent = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
                }, 1000);
            };

            const executeBot = async () => {
                document.getElementById('countdown').textContent = "¬°AHORA!";
                status.value = "¬°Ejecutando ahora!";
                document.getElementById('bot-status').style.color = '#16a34a';

                const botConfig = {
                    email: "aldofmh@gmail.com", password: "2970Ferr!",
                    activity_name: "P√°del",
                    space_name: config.value.space_name, date: config.value.date,
                    target_hours: config.value.target_hours,
                    team_name: "1", number_players: 4,
                };
                
                console.clear();
                const logger = {
                    info: (msg) => console.log(`%c‚úÖ ${msg}`, 'color: #22c55e; font-weight: bold;'),
                    error: (msg) => console.error(`%c‚ùå ${msg}`, 'color: #ef4444; font-weight: bold;'),
                    step: (msg) => console.log(`%c‚û°Ô∏è ${msg}`, 'color: #3b82f6; font-size: 1.1em; font-weight: bold;'),
                };
                
                logger.step("--- INICIANDO BOT ---");
                try {
                    logger.step("1. Obteniendo token...");
                    const authRes = await fetch('https://reserva-parque.hidalgo.gob.mx/api/v1/auth/signin', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ email: botConfig.email, password: botConfig.password }) });
                    const authData = await authRes.json();
                    if (!authData.token) throw new Error("Login fallido");
                    const { token, user } = authData;

                    logger.step("2. Obteniendo IDs de sistema...");
                    const activities = await (await fetch('https://reserva-parque.hidalgo.gob.mx/api/v1/activity', { headers: { 'Authorization': `Bearer ${token}` } })).json();
                    const activity = activities.find(a => a.name === botConfig.activity_name);
                    const space = activity.spaces.find(s => s.name === botConfig.space_name);

                    logger.step(`3. Obteniendo horarios para ${botConfig.date}...`);
                    const scheduleData = await (await fetch(`https://reserva-parque.hidalgo.gob.mx/api/v1/reservation/schedules?space_id=${space._id}&date=${botConfig.date}`, { headers: { 'Authorization': `Bearer ${token}` } })).json();
                    const availableSchedules = scheduleData.available || [];
                    
                    let successCount = 0;
                    for (const hour of botConfig.target_hours) {
                        const timeSlot = `${hour}:00-${String(parseInt(hour.split(':')[0]) + 1).padStart(2, '0')}:00:00`;
                        if (availableSchedules.includes(timeSlot)) {
                            const payload = { solicitante_id: user._id, activity_id: activity._id, space_id: space._id, date: botConfig.date, time_slot: timeSlot, teamName: botConfig.team_name, number_players: botConfig.number_players, responsive: true, equipment: false };
                            const res = await fetch('https://reserva-parque.hidalgo.gob.mx/api/v1/application', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify(payload) });
                            const resData = await res.json();
                            if(res.ok) { logger.info(`¬°RESERVA CONFIRMADA para ${hour}! Folio: ${resData.folio}`); successCount++; } else { logger.error(`Fallo al reservar ${hour}: ${resData.message}`);}
                        } else { logger.error(`Horario ${hour} no disponible.`); }
                        await new Promise(r => setTimeout(r, 1000));
                    }
                    status.value = `Proceso finalizado: ${successCount} reserva(s) exitosa(s).`;
                } catch(e) {
                    status.value = `Error cr√≠tico: ${e.message}`;
                    logger.error(`Error: ${e.message}`);
                }
            };
            
            return { activeTab, tabs, config, availableHours, status, toggleHour, saveConfig, schedule, saveButtonText };
        }
    }).mount('#app');
    </script>
</body>
</html>
